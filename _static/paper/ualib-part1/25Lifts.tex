% -*- TeX-master: "ualib-part1.tex" -*-
%%% Local Variables: 
%%% mode: latex
%%% TeX-engine: 'xetex
%%% End:
\subsubsection{Agda's universe hierarchy}\label{agdas-universe-hierarchy}

% The hierarchy of universe levels in Agda looks like this:\\[-4pt]

% \ab{ùì§‚ÇÄ} \as : \ab{ùì§‚ÇÅ}\AgdaOperator{\AgdaFunction{Ãá}} , ~ ~ \ab{ùì§‚ÇÅ} \as : \ab{ùì§‚ÇÇ}\AgdaOperator{\AgdaFunction{Ãá}} , ~ ~ \ab{ùì§‚ÇÇ} \as : \ab{ùì§‚ÇÉ}\AgdaOperator{\AgdaFunction{Ãá}} , \ldots{}\\[4pt]
% This means that the type level of \ab{ùì§‚ÇÄ} is \ab{ùì§‚ÇÅ}\AgdaOperator{\AgdaFunction{Ãá}}, and for each \ab n the type level of \ab{ùì§‚Çô} is \ab{ùì§‚Çô‚Çä‚ÇÅ}\AgdaOperator{\AgdaFunction{Ãá}}.
% It is important to note, however, this does \emph{not} imply that \ab{ùì§‚ÇÄ} \as
% : \ab{ùì§‚ÇÇ}\AgdaOperator{\AgdaFunction{Ãá}} and \ab{ùì§‚ÇÄ} \as :
% \ab{ùì§‚ÇÉ}\AgdaOperator{\AgdaFunction{Ãá}}, and so on. 
% In As mentioned above (\S~\ref{ssec:agdas-universe-hierarchy}), Agda's universe hierarchy is \defn{noncummulative}.

The hierarchy of universes in Agda is structured as follows: \ab{ùì§}\af Ãá \as : \ab ùì§ \af ‚Å∫\af Ãá, \hskip3mm
\ab{ùì§} \af ‚Å∫\af Ãá \as : \ab ùì§ \af ‚Å∫\af ‚Å∫\af Ãá, etc. This means that the universe \ab ùì§\af Ãá has type \ab ùì§  \af ‚Å∫\af Ãá, and ùì§ \af ‚Å∫\af Ãá has type \ab ùì§ \af ‚Å∫\af ‚Å∫\af Ãá, and so on.  It is important to note, however, this does \emph{not} imply that \ab ùì§\af Ãá \as : \ab ùì§ \af ‚Å∫\af ‚Å∫\af Ãá. In other words, Agda's universe hierarchy is \emph{noncummulative}. This makes it possible to treat universe levels more generally and precisely, which is nice. On the other hand, a noncummulative hierarchy can sometimes make for a nonfun proof assistant. Specifically, in certain situations, the noncummulativity makes it unduly difficult to convince Agda that a program or proof is correct. 

Presently (in \S\ref{lifting-and-lowering}) we will describe general lifting and lowering functions that help us overcome this technical issue. Later (in \S\ref{lifts-of-algebras}) we provide some domain-specific analogs of these tools. We will prove some nice properties that make these effective mechanisms for resolving universe level problems when working with algebra types.

\subsubsection{Lifting and lowering}\label{lifting-and-lowering}
Let us be more concrete about what is at issue here by considering a typical example. Agda frequently encounters errors during the type-checking process and responds by printing an error message. Often the message has the following form.
{\color{red}{\small
\begin{verbatim}
  Birkhoff.lagda:498,20-23
  ùì§ != ùìû ‚äî ùì• ‚äî (ùì§ ‚Å∫) when checking that... has type...
\end{verbatim}}}
\noindent This error message means that Agda encountered the universe \ab{ùì§} on line 498 (columns 20--23) of the file \af{Birkhoff.lagda}, but was expecting to find the universe \ab{ùìû}~\aop ‚äî~\ab ùì•~\aop ‚äî~(\ab ùì§\af ‚Å∫) instead.

There are some general ``lifting and lowering'' tools that make these situations easier to deal with. These must be applied with some care to avoid making the type theory inconsistent. In particular, we cannot lower the level of a type unless it was previously lifted to a (higher than necessary) universe level.

A general \af{Lift} record type, similar to the one found in the \am{Level} module of the \agdastdlib, is defined as follows.
\ccpad
\begin{code}%
\>[0]\AgdaKeyword{record}\AgdaSpace{}%
\AgdaRecord{Lift}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{ùì¶}\AgdaSpace{}%
\AgdaBound{ùì§}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPostulate{Universe}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{A}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{ùì§}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{Ãá}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{ùì§}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{‚äî}}\AgdaSpace{}%
\AgdaBound{ùì¶}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{Ãá}}%
\>[50]\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[1]\AgdaKeyword{constructor}\AgdaSpace{}%
\AgdaInductiveConstructor{lift}\<%
\\
%
\>[1]\AgdaKeyword{field}\AgdaSpace{}%
\AgdaField{lower}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Lift}\<%
\end{code}
\scpad

The point of having a ramified hierarchy of universes is to avoid Russell's paradox, and this would be subverted if we were to lower the universe of a type that wasn't previously lifted.  However, we can prove that if an application of \afld{lower} is immediately followed by an application of \aic{lift}, then the result is the identity transformation. Similarly, \aic{lift} followed by \afld{lower} is the identity.
\ccpad
\begin{code}%
\>[0]\AgdaFunction{lift‚àºlower}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{ùì¶}\AgdaSpace{}%
\AgdaBound{ùì§}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPostulate{Universe}\AgdaSymbol{\}\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{ùì§}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{Ãá}}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaInductiveConstructor{lift}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àò}}\AgdaSpace{}%
\AgdaField{lower}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{‚â°}}\AgdaSpace{}%
\AgdaFunction{ùëñùëë}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaRecord{Lift}\AgdaSymbol{\{}\AgdaBound{ùì¶}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{lift‚àºlower}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{lower‚àºlift}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{ùì¶}\AgdaSpace{}%
\AgdaBound{ùì§}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPostulate{Universe}\AgdaSymbol{\}\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{ùì§}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{Ãá}}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaField{lower}\AgdaSymbol{\{}\AgdaBound{ùì¶}\AgdaSymbol{\}\{}\AgdaBound{ùì§}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àò}}\AgdaSpace{}%
\AgdaInductiveConstructor{lift}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{‚â°}}\AgdaSpace{}%
\AgdaFunction{ùëñùëë}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[0]\AgdaFunction{lower‚àºlift}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\end{code}
\ccpad
The proofs are trivial. Nonetheless we'll find a few holes that these observations can fill.





% Using the \af{Lift} type, we define two functions that lift the domain (respectively, codomain) type of a function to a higher universe.
% \ccpad
% \begin{code}%
% \>[1]\AgdaFunction{lift-dom}\AgdaSpace{}%
% \AgdaSymbol{:}\AgdaSpace{}%
% \AgdaSymbol{\{}\AgdaBound{X}\AgdaSpace{}%
% \AgdaSymbol{:}\AgdaSpace{}%
% \AgdaBound{ùìß}\AgdaSpace{}%
% \AgdaOperator{\AgdaFunction{Ãá}}\AgdaSymbol{\}\{}\AgdaBound{Y}\AgdaSpace{}%
% \AgdaSymbol{:}\AgdaSpace{}%
% \AgdaBound{ùì®}\AgdaSpace{}%
% \AgdaOperator{\AgdaFunction{Ãá}}\AgdaSymbol{\}}\AgdaSpace{}%
% \AgdaSymbol{‚Üí}\AgdaSpace{}%
% \AgdaSymbol{(}\AgdaBound{X}\AgdaSpace{}%
% \AgdaSymbol{‚Üí}\AgdaSpace{}%
% \AgdaBound{Y}\AgdaSymbol{)}\AgdaSpace{}%
% \AgdaSymbol{‚Üí}\AgdaSpace{}%
% \AgdaSymbol{(}\AgdaRecord{Lift}\AgdaSymbol{\{}\AgdaBound{ùì¶}\AgdaSymbol{\}\{}\AgdaBound{ùìß}\AgdaSymbol{\}}\AgdaSpace{}%
% \AgdaBound{X}\AgdaSpace{}%
% \AgdaSymbol{‚Üí}\AgdaSpace{}%
% \AgdaBound{Y}\AgdaSymbol{)}\<%
% \\
% %
% \>[1]\AgdaFunction{lift-dom}\AgdaSpace{}%
% \AgdaBound{f}\AgdaSpace{}%
% \AgdaSymbol{=}\AgdaSpace{}%
% \AgdaSymbol{Œª}\AgdaSpace{}%
% \AgdaBound{x}\AgdaSpace{}%
% \AgdaSymbol{‚Üí}\AgdaSpace{}%
% \AgdaSymbol{(}\AgdaBound{f}\AgdaSpace{}%
% \AgdaSymbol{(}\AgdaField{lower}\AgdaSpace{}%
% \AgdaBound{x}\AgdaSymbol{))}\<%
% \\
% %
% \\[\AgdaEmptyExtraSkip]%
% %
% \>[1]\AgdaFunction{lift-cod}\AgdaSpace{}%
% \AgdaSymbol{:}\AgdaSpace{}%
% \AgdaSymbol{\{}\AgdaBound{X}\AgdaSpace{}%
% \AgdaSymbol{:}\AgdaSpace{}%
% \AgdaBound{ùìß}\AgdaSpace{}%
% \AgdaOperator{\AgdaFunction{Ãá}}\AgdaSymbol{\}\{}\AgdaBound{Y}\AgdaSpace{}%
% \AgdaSymbol{:}\AgdaSpace{}%
% \AgdaBound{ùì®}\AgdaSpace{}%
% \AgdaOperator{\AgdaFunction{Ãá}}\AgdaSymbol{\}}\AgdaSpace{}%
% \AgdaSymbol{‚Üí}\AgdaSpace{}%
% \AgdaSymbol{(}\AgdaBound{X}\AgdaSpace{}%
% \AgdaSymbol{‚Üí}\AgdaSpace{}%
% \AgdaBound{Y}\AgdaSymbol{)}\AgdaSpace{}%
% \AgdaSymbol{‚Üí}\AgdaSpace{}%
% \AgdaSymbol{(}\AgdaBound{X}\AgdaSpace{}%
% \AgdaSymbol{‚Üí}\AgdaSpace{}%
% \AgdaRecord{Lift}\AgdaSymbol{\{}\AgdaBound{ùì¶}\AgdaSymbol{\}\{}\AgdaBound{ùì®}\AgdaSymbol{\}}\AgdaSpace{}%
% \AgdaBound{Y}\AgdaSymbol{)}\<%
% \\
% %
% \>[1]\AgdaFunction{lift-cod}\AgdaSpace{}%
% \AgdaBound{f}\AgdaSpace{}%
% \AgdaSymbol{=}\AgdaSpace{}%
% \AgdaSymbol{Œª}\AgdaSpace{}%
% \AgdaBound{x}\AgdaSpace{}%
% \AgdaSymbol{‚Üí}\AgdaSpace{}%
% \AgdaInductiveConstructor{lift}\AgdaSpace{}%
% \AgdaSymbol{(}\AgdaBound{f}\AgdaSpace{}%
% \AgdaBound{x}\AgdaSymbol{)}\<%
% \end{code}
% \ccpad
% Naturally, we can combine these and define a function that lifts both the domain and codomain type.
% \ccpad
% \begin{code}
% \>[1]\AgdaFunction{lift-fun}\AgdaSpace{}%
% \AgdaSymbol{:}\AgdaSpace{}%
% \AgdaSymbol{\{}\AgdaBound{X}\AgdaSpace{}%
% \AgdaSymbol{:}\AgdaSpace{}%
% \AgdaBound{ùìß}\AgdaSpace{}%
% \AgdaOperator{\AgdaFunction{Ãá}}\AgdaSymbol{\}\{}\AgdaBound{Y}\AgdaSpace{}%
% \AgdaSymbol{:}\AgdaSpace{}%
% \AgdaBound{ùì®}\AgdaSpace{}%
% \AgdaOperator{\AgdaFunction{Ãá}}\AgdaSymbol{\}}\AgdaSpace{}%
% \AgdaSymbol{‚Üí}\AgdaSpace{}%
% \AgdaSymbol{(}\AgdaBound{X}\AgdaSpace{}%
% \AgdaSymbol{‚Üí}\AgdaSpace{}%
% \AgdaBound{Y}\AgdaSymbol{)}\AgdaSpace{}%
% \AgdaSymbol{‚Üí}\AgdaSpace{}%
% \AgdaSymbol{(}\AgdaRecord{Lift}\AgdaSymbol{\{}\AgdaBound{ùì¶}\AgdaSymbol{\}\{}\AgdaBound{ùìß}\AgdaSymbol{\}}\AgdaSpace{}%
% \AgdaBound{X}\AgdaSpace{}%
% \AgdaSymbol{‚Üí}\AgdaSpace{}%
% \AgdaRecord{Lift}\AgdaSymbol{\{}\AgdaBound{ùì©}\AgdaSymbol{\}\{}\AgdaBound{ùì®}\AgdaSymbol{\}}\AgdaSpace{}%
% \AgdaBound{Y}\AgdaSymbol{)}\<%
% \\
% %
% \>[1]\AgdaFunction{lift-fun}\AgdaSpace{}%
% \AgdaBound{f}\AgdaSpace{}%
% \AgdaSymbol{=}\AgdaSpace{}%
% \AgdaSymbol{Œª}\AgdaSpace{}%
% \AgdaBound{x}\AgdaSpace{}%
% \AgdaSymbol{‚Üí}\AgdaSpace{}%
% \AgdaInductiveConstructor{lift}\AgdaSpace{}%
% \AgdaSymbol{(}\AgdaBound{f}\AgdaSpace{}%
% \AgdaSymbol{(}\AgdaField{lower}\AgdaSpace{}%
% \AgdaBound{x}\AgdaSymbol{))}\<%
% \end{code}
% \ccpad
% For example, \af{lift-dom} takes a function \ab f defined on the domain \AgdaBound{X}\AgdaSpace{}\AgdaSymbol{:}\AgdaSpace{}\AgdaBound{ùìß}\AgdaSpace{}\AgdaOperator{\AgdaFunction{Ãá}}\AgdaSpace{} and returns a function defined on the domain \ar{Lift}\as{\{}\ab ùì¶\as{\}}\as{\{}\ab ùìß\as{\}} \ab X \as : \ab ùìß \aop ‚äî \ab ùì¶\aof Ãá.
